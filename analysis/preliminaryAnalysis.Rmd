---
title: "An assessment of statistical guidance for authors at influential academic journals across scientific disciplines: Preliminary analysis"
author: "Maia & Tom"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = T)
```

```{r load_packages}
library(knitr) # for literate programming
library(papaja) # for article template
library(tidyverse) # for data munging
library(tidylog) # inline analysis feedback
library(here) # for finding files
library(gtsummary) # for summary tables
```

```{r load_functions}
# load custom functions
source(here('analysis','functions.R'))
```

```{r perform_preprocessing}
# loads raw data, performs preprocessing, saves preprocessed files
source(here('analysis','preprocessing.R'))
```

```{r load_processed_data}
# loads the processed data files output by the preprocessing performed above
load(here('data','processed','d_coding.rds'))
load(here('data','processed','d_journals.rds'))
load(here('data','processed','lookup_external_guidance.rds'))
```



```{r set_style_defaults}
theme_gtsummary_compact() # set table theme
```

<br>
We have now completed data collection for the first phase of this project. The preregistered study protocol is available [here](https://osf.io/cz9g3/). Below we present a preliminary analysis of the phase one data.

There are three types of guidance:
* journal specific i.e., guidance written specifically for a particular journal and including in author-facing instructions/guidance documentation
* publisher i.e., guidance written for a group of journals that share the same publisher, for example "Cell STAR Methods"
* external i.e., academic papers or non-publisher reporting guidelines (usually present on EQUATOR)

Look at counts and proportions mentioning each topic. Use all journals for denominator. Overall and by field.

``````{r tbl_counts_props}
d_journals %>% 
  select(journal, esi_field) %>% 
  left_join(d_coding, ., by = "journal") %>% 
  
  # Recode NAs to FALSE
  mutate(across(
    everything()
    # starts_with("has_") & (!contains("guidance")) # for internal guidance elements
    , ~replace_na(., FALSE) )) %>% 
  
  select(esi_field, starts_with("has_")) %>% 
  gtsummary::tbl_summary(
    by = esi_field,
      # statistic = list(everything() ~ "{p}% ({n} / {N})")
  ) %>%
  add_overall %>% 
  modify_footnote(everything() ~ NA) %>% 
  modify_caption("**Number and proportion of journals overall and by field providing internal statistical guidance by topic.** Denominator for all proportions is the number of journals in the field, regardless of whether the journal has internal guidance.")
```

Some initial observations
- Math and computer science are indeed at 0% across the board.
- Clinical medicine has 100% guidance. Also high in related field: biology & biochemistry, immunology, molecular bio & genetics. Also psych and neuro fields.

Try a mosaic plot for internal guidance...nope!

```{r plot_internal_guidance_mosaic}
my_palette <- c("lightcoral", "lightgrey", "lightblue")

d_internal_guidance <-
  d_coding %>% 
  select(journal, starts_with("has_") & (!contains("guidance"))) %>% 
  pivot_longer(
    -journal,
    names_to = "topic",
    values_to = "outcome",
    values_drop_na = FALSE
  ) %>% 
  mutate(outcome = case_when(
    outcome ~ "Mentioned",
    !outcome ~ "Not mentioned",
    TRUE ~ "Not applicable (No internal guidance)"
  ))

# plt <- 
  d_internal_guidance %>%
  ggplot(aes(x = topic, y = factor(journal))) +
  geom_tile(aes(fill = outcome), colour = 'black', size = .25) +
  scale_fill_manual(
    values = my_palette,
    # labels = c('Not mentioned', 'Unclear', 'Mentioned')
  ) +
  scale_x_discrete(position = 'top') +
  papaja::theme_apa() +
  xlab("Topics mentioned") +
  theme(plot.margin = margin(0, 50, 0, 0),
        axis.ticks = element_blank(),
        axis.title.y =element_blank(),
        panel.grid.major=element_line(colour=NA), 
        panel.grid.minor=element_line(colour=NA),
        legend.position = 'bottom',
        axis.text.x  = element_text(angle = 45, hjust = 0),
        strip.background = element_rect(
          color="black", fill="white", size=0, linetype="solid"
        ),
        strip.text.y = element_text(
          size = 8, color = "black", face = 'bold'
        ))

# ggsave('internal-guidance.png', width = 11, height = 10)
```

Try bar chart

```{r plot_internal_guidance_bar}
d_internal_guidance %>% 
  ggplot(aes(y = topic, fill = outcome)) +
  geom_bar() +
  scale_fill_manual(values = my_palette)
```

Look at external guidance

```{r tbl_external_guidance}
lookup_external_guidance %>% 
  knitr::kable()
```

External guidance types

```{r tbl_external_guidance_types}
lookup_external_guidance %>% 
  count(guidance_type) %>% 
  kable()
```