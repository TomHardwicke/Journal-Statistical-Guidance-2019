---
title: "An assessment of statistical guidance for authors at influential academic journals across scientific disciplines: Preliminary analysis"
author: "Analysis performed by: Maia Salholz-Hillel & Tom Hardwicke"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: true
    number_sections: true
    global_numbering: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = T, fig.topcaption = TRUE)
```

```{r load_packages}
library(knitr) # for literate programming
library(papaja) # for article template
library(tidyverse) # for data munging
library(tidylog) # inline analysis feedback
library(here) # for finding files
library(gtsummary) # for summary tables note: use dev version `remotes::install_github("ddsjoberg/gtsummary")`
library(lemon) # to have axes across all graph facets
library(ggthemr) # for ggplot theme
library(ggrepel) # for ggplot text labels
library(scales) # to wrap text on axis labels
```

```{r load_functions}
# load custom functions
source(here('analysis','functions.R'))
```

```{r perform_preprocessing}
# loads raw data, performs preprocessing, saves preprocessed files
source(here('analysis','preprocessing.R'))
```

```{r load_processed_data}
# loads the processed data files output by the preprocessing performed above
load(here('data','processed','d_all.rds'))
load(here('data','processed','lookup_external_guidance.rds'))
```

```{r set_defaults}
theme_gtsummary_compact() # set table theme
ggthemr('fresh') # set ggplot theme
```

# Introduction
<br>
We have now completed data collection for the first phase of this project. We extracted author-facing statistical guidance provided by the top-15 journals (by Impact Factor) in each of 22 scientific disciplines (i.e., total N = 330 journals). The preregistered study protocol is available [here](https://osf.io/cz9g3/). Below we present a preliminary analysis of the phase one data and highlight some issues to discuss as a team.

# Methods summary

> **Operational definition of statistical guidance**: any advice or instruction related to the appropriate selection, implementation, reporting, or interpretation of statistical analyses.

We recorded whether each journal:

* Provided any statistical guidance at all
* Had a dedicated statistical guidance section
* Referred to statistical guidance in external sources (e.g., reporting guidelines or articles)

If any statistical guidance was provided by a journal:

* We coded (YES/NO) whether it mentioned each of 20 statistical topics (e.g., "p-values"), and extracted the verbatim text.

**Note:** When journals referred to guidance in external sources, we have recorded the names of the sources, but *we have not currently extracted guidance from those sources*. We return to this point in the *issues to address* section (Section \@ref(issues)) at the end of this document.

All data extraction was performed by a first coder (DS, MM, TB, MSH) and a second coder (TEH) with any coding differences resolved through discussion.

```{r shared_publisher_journals}
# count number of journals that have shared publisher guidance
publisher_nature_n <- d_all %>% filter(publisher_guidance == "Nature") %>% nrow()
publisher_cell_n <- d_all %>% filter(publisher_guidance == "Cell") %>% nrow()
publisher_frontiers_n <- d_all %>% filter(publisher_guidance == "Frontiers") %>% nrow()
```

**Note:** We found that some publishers provided statistical guidance that was shared across their portfolio of journals (specifically, `r publisher_nature_n` Nature journals, `r publisher_cell_n` Cell journals, and `r publisher_frontiers_n` Frontiers journals). Shared publisher guidance was coded by two team members (as above), but is represented in our data and analysis multiple times - once for each individual journal it applies to. For example, the Cell journals guidance is inherited by `r publisher_cell_n` journals so appears `r publisher_cell_n` times in the dataset. Unless stated otherwise, publisher guidance is treated as journal-specific guidance (i.e., not external guidance) in the analyses presented below.

# Results

```{r summarise_data}

# couldn't figure out to extract summary data from gtsummary::tblsummary so making my own summary dataframe
sum_tab <- d_all %>%
  
  # Recode NAs to FALSE
  mutate(across(
    everything()
    # starts_with("has_") & (!contains("guidance")) # for internal guidance elements
    , ~replace_na(., FALSE) )) %>% 
  
  select(esi_field, starts_with("has_")) %>% 
  group_by(esi_field) %>%
  summarise(across(starts_with("has_"), list(n = sum, N = ~n()), .names = "{col}__{fn}")) %>%
  adorn_totals(name = 'OVERALL') %>%
  pivot_longer(cols = !esi_field, names_to = c('variable', '.value'), names_sep = '__', names_prefix = 'has_') %>%
  mutate(prop = n/N, percent = round(prop*100, 0)) %>%
  mutate(esi_abbr = case_when( # create abbreviated field labels
    esi_field == "OVERALL" ~ "OVERALL",
    esi_field == "AGRICULTURAL SCIENCES" ~ "AGRI",
    esi_field == "BIOLOGY & BIOCHEMISTRY" ~ "BIO",       
    esi_field == "CHEMISTRY" ~ "CHEM" ,                   
    esi_field == "CLINICAL MEDICINE" ~ "MED",           
    esi_field == "COMPUTER SCIENCE" ~ "COMSCI",             
    esi_field == "ECONOMICS & BUSINESS" ~ "ECON",         
    esi_field == "ENGINEERING" ~ "ENGIN",                  
    esi_field == "ENVIRONMENT_ECOLOGY" ~ "ECO",         
    esi_field == "GEOSCIENCES" ~ "GEO",                  
    esi_field == "IMMUNOLOGY" ~ "IMMUN",                   
    esi_field == "MATERIALS SCIENCE" ~ "MATSCI",            
    esi_field == "MATHEMATICS" ~ "MATH",                
    esi_field == "MICROBIOLOGY" ~ "MICBIO",                 
    esi_field == "MOLECULAR BIOLOGY & GENETICS" ~ "MOLBIO", 
    esi_field == "Multidisciplinary" ~ "MULTI",            
    esi_field == "NEUROSCIENCE & BEHAVIOR" ~ "NEURO",     
    esi_field == "PHARMACOLOGY & TOXICOLOGY" ~ "PHARM",    
    esi_field == "PHYSICS" ~ "PHYS",                     
    esi_field == "PLANT & ANIMAL SCIENCE" ~ "PLANT",       
    esi_field == "PSYCHIATRY_PSYCHOLOGY" ~ "PSY",       
    esi_field == "SOCIAL SCIENCES, GENERAL" ~ "SOCSCI",     
    esi_field == "SPACE SCIENCE" ~ "SPACE"          
  )) %>%
  mutate(esi_field_with_abbr = paste0(esi_field,' (', esi_abbr,')')) %>%
  mutate(var_display = case_when( # create display versions of topic names
    variable == "guidance" ~ "Provides any statistical guidance",
    variable == "internal_guidance" ~ "Provides journal-specific statistical guidance",
    variable == "internal_guidance_section" ~ "Has a dedicated statistical guidance section",
    variable == "external_guidance" ~ "Refers to external statistical guidance",
    variable == "p_value" ~ "p values",
    variable == "significance" ~ "statistical significance",
    variable == "null_hypo" ~ "null hypotheses",
    variable == "sample_size" ~ "sample size justification",
    variable == "conf_int" ~ "confidence intervals",
    variable == "effect_size" ~ "effect sizes",
    variable == "multi_compare" ~ "multiple comparisons",
    variable == "subgroup" ~ "subgroup analyses",
    variable == "baseline_covar" ~ "baseline covariates",
    variable == "non_param" ~ "non-parametric tests",
    variable == "sensitivity" ~ "sensitivity analyses",
    variable == "model_assume" ~ "checking model assumptions",
    variable == "exclusion" ~ "data exclusions",
    variable == "outliers" ~ "handling outliers",
    variable == "missing" ~ "handling missing data",
    variable == "one_sided" ~ "one-sided tests",
    variable == "bayes" ~ "Bayesian statistics",
    variable == "secondary" ~ "secondary outcomes",
    variable == "prespecify" ~ "prespecification of analyses",
    variable == "cat_continuous" ~ "categorisation of continuous data",
    variable == "publisher_guidance" ~ "Shares publisher guidance"
  ))

# get fields with no statistical guidance at all
null_fields <- sum_tab %>% 
  filter(
    variable == "guidance",
    prop == 0
  ) %>%
  pull(esi_field)

# select only data on general any/internal/external statistical guidance classifications 
sum_tab_general <- sum_tab %>%
  filter(variable %in% c('guidance', 'internal_guidance', 'internal_guidance_section', 'external_guidance')) %>% # select only data on general classifications
  mutate(variable = factor(variable, levels = c('guidance', 'internal_guidance', 'internal_guidance_section', 'external_guidance')),
         var_display = factor(var_display, levels = c("Provides any statistical guidance", "Provides journal-specific statistical guidance", "Has a dedicated statistical guidance section", "Refers to external statistical guidance"))) # set variable order

# select only data on topics
sum_tab_topics <- sum_tab %>%
  filter(esi_field %notin% null_fields) %>% # remove fields that have no statistical guidance at all
  filter(variable %notin% c('guidance', 'internal_guidance', 'internal_guidance_section', 'external_guidance', 'publisher_guidance')) %>% # select only data on topics
  rename(topic = variable, topic_display = var_display)

# get list of statistical topics in order of overall proportions
ordered_topics <- sum_tab_topics %>%
  filter(esi_field == "OVERALL") %>%
  arrange(desc(prop)) %>% # order from highest to lowest
  pull(topic_display)

# set order of topics
sum_tab_topics <- sum_tab_topics %>%
  mutate(topic_display = factor(topic_display, levels = ordered_topics))
```

Figure \@ref(fig:statguidefig) shows the percentage of journals in each scientific discipline (denominator is N = 15) and overall (denominator is N = 330) that (a) offered any statistical guidance; (b) had a dedicated statistical guidance section. For tabular data, see Appendix \@ref(app).

```{r crosstab_int_ext}
crosstab_int_ext <- d_all %>% count(has_internal_guidance, has_external_guidance)
only_ext <- crosstab_int_ext %>% filter(has_internal_guidance == F, has_external_guidance == T) %>% pull(n)
```

You can see that around half (`r sum_tab %>% filter(esi_field == "OVERALL", variable == "guidance") %>% pull(percent)`%) of journals offered any statistical guidance. Note that this includes `r only_ext` journals which only referred to statistical guidance in external sources (reporting guidelines or academic papers). Just over quarter of journals had a dedicated statistical guidance section of their author instructions (`r sum_tab %>% filter(esi_field == "OVERALL", variable == "internal_guidance_section") %>% pull(percent)`%). In two fields (Computer Science and Maths), no journals offered any statistical guidance. Journals in health-related fields were more likely to offer statistical guidance and have dedicated statistical guidance sections. Notably, 100% of the journals in clinical medicine offered some statistical guidance. 

<br>

```{r statguidefig, fig.cap = "Percentage of journals offering statistical guidance by scientific discipline (N = 15; represented by coloured dots) and overall (N = 330; represented by black diamond). Graphs ordered from left to right and top to bottom in order of highest proportion overall across scientific disciplines.", fig.topcaption = TRUE, fig.width = 10, fig.height = 6}
# extract overall data
sum_tab_general_overall <- sum_tab_general %>%
  filter(variable %in% c('guidance', 'internal_guidance_section')) %>%
  filter(esi_field == "OVERALL")

sum_tab_general %>%
  filter(esi_field != "OVERALL") %>%
  filter(variable %in% c('guidance', 'internal_guidance_section')) %>%
  ggplot(aes(x=percent, y = 1, colour = str_wrap(esi_field_with_abbr,25))) +
  facet_rep_wrap(facets = vars(var_display), ncol = 2, nrow = 1) +
  coord_capped_cart(bottom='both', left='both') + # to break axes in bottom left corner
  geom_point(size = 5, position = position_stack(), alpha = .5) +
  geom_point(size = 6, position = position_stack(), data = sum_tab_general_overall, colour = 'black', shape = 18) +
  geom_text_repel(
    aes(label = ifelse(percent > 0,esi_abbr,''),
        segment.square = T,
        segment.inflect = T), #
    #point.padding = 0.2,
    force_pull   = 0, # do not pull toward data points
    nudge_y      = 15,
    #nudge_x = 5,
    direction    = "x",
    angle        = 90,
    hjust        = 0,
    segment.size = 0.2,
    segment.curvature = -1e-20,
    max.iter = 1e4, max.time = 1,
    max.overlaps = Inf, # ensure all labels are shown even if overlapping
    show.legend = FALSE # do not add legend entry
  ) +
  scale_y_continuous(limits = c(0,15), name = '1 dot per scientific discipline') +
  xlim(0,100) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.position = 'bottom') +
  scale_colour_discrete(name = 'Scientific disciplines') +
  guides(colour = guide_legend(nrow = 6, title.position = 'top'))
```

<br><br>

Figure \@ref(fig:stattopicsfig) shows the percentage of journals in each scientific discipline (denominator is N = 15) and overall (denominator is N = 330) that mentioned each of the twenty pre-specified statistical topics. For tabular data, see the Appendix (Section \@ref(app)). Please see Section \@ref(issues) (issues) at the end of this document for an important note regarding the topic "prespecification of analyses".

<br>

```{r stattopicsfig, fig.cap = "Percentage of journals offering guidance on twenty statistical topics by scientific discipline (N = 15; represented by coloured dots) and overall (N = 330; represented by black diamond). For presentational purposes, disciplines offering no guidance on individual topics are shown, but not labelled. Two scientific disciplines in which no journals offered any statistical guidance at all are not shown. Graphs ordered from left to right and top to bottom in order of highest proportion overall across scientific disciplines.", fig.topcaption = TRUE, fig.width = 10, fig.height = 28}
# extract overall data
sum_tab_topics_overall <- sum_tab_topics %>%
  filter(esi_field == "OVERALL")

sum_tab_topics %>%
  filter(esi_field != "OVERALL") %>%
  ggplot(aes(x=percent, y = 1, colour = str_wrap(esi_field_with_abbr,25))) +
  facet_rep_wrap(facets = vars(topic_display), ncol = 2) +
  coord_capped_cart(bottom='both', left='both') + # to break axes in bottom left corner
  geom_point(size = 5, position = position_stack(), alpha = .5) +
  geom_point(size = 6, position = position_stack(), data = sum_tab_topics_overall, colour = 'black', shape = 18) +
  geom_text_repel(
    aes(label = ifelse(percent > 0,esi_abbr,''),
        segment.square = T,
        segment.inflect = T), #
    #point.padding = 0.2,
    force_pull   = 0, # do not pull toward data points
    nudge_y      = 25,
    nudge_x = 10,
    direction    = "x",
    angle        = 90,
    hjust        = 0,
    segment.size = 0.2,
    segment.curvature = -1e-20,
    max.iter = 1e4, max.time = 1,
    max.overlaps = Inf, # ensure all labels are shown even if overlapping
    show.legend = FALSE # do not add legend entry
  ) +
  scale_y_continuous(limits = c(0,25), name = '1 dot per scientific discipline') +
  xlim(0,100) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.position = 'bottom') +
  scale_colour_discrete(name = 'Scientific disciplines') +
  guides(colour = guide_legend(nrow = 5, title.position = 'top'))
```

<br>

You can see that some topics (e.g., confidence intervals, p-values) are much more likely to be mentioned than other topics (e.g., handling outliers, categorisation of continuus data). Journals in health-related fields, particularly clinical medicine, are often more likely to mention these topics than journals in other fields.

```{r how_much_guidance}
n_topics <- d_all %>% filter(has_guidance == T, has_internal_guidance == T) %>%
  
  # Recode NAs to FALSE
  mutate(across(
    everything()
    , ~replace_na(., FALSE) )) %>% 
  select(journal, starts_with("has_"), -c(has_guidance, has_internal_guidance, has_internal_guidance_section, has_external_guidance, has_publisher_guidance)) %>%
  pivot_longer(cols = !journal, names_to = 'topic', values_to = 'value') %>%
  group_by(journal) %>%
  summarise(topics_mentioned = sum(value))
```

<br>

For the `r d_all %>% filter(has_guidance == T, has_internal_guidance == T) %>% nrow()` journals that offered some internal guidance (i.e., excluding those that offered no guidance at all and those that only referred to external sources), the histogram in Figure \@ref(fig:topicshist) illustrates that the maximum number of topics mentioned by an individual journal was `r max(n_topics$topics_mentioned)`. There were `r n_topics %>% filter(topics_mentioned == 0) %>% nrow()` journals that did not mention any of our prespecified topics (but provided statistical guidance on other topics). The median topics mentioned was `r median(n_topics$topics_mentioned)`.

<br>

```{r topicshist, fig.cap = 'Histogram showing how many of the twenty statistical topics were mentioned by each journal'}
n_topics %>%
  ggplot(aes(x=topics_mentioned)) +
  geom_histogram()
```

<br>

In the grid below (Figure \@ref(fig:guidancemosaic)), you can see which of the twenty topics were mentioned by each journal. Journals that shared publisher guidance are represented by one row (per publisher). Journals that did not offer any statistical guidance at all, or journals that referred only to guidance in external sources, are not shown.

<br>

```{r}
my_palette <- c("#56B4E9", "#E69F00")

d_internal_guidance_noPublisher <-
  d_all %>%
  filter(has_internal_guidance == T, # select journals with internal guidance
         has_publisher_guidance == F | journal == "Scientific Data") # remove journals with shared publisher guidance except for Scientific Data (which shared guidance and its own guidance)

# were going to represent journals with publisher guidance in a single row per publisher. 
# select exemplar journals for each publisher
publisher_nature <- d_all %>% filter(journal == "Nature") %>% mutate(journal = paste0("Nature journals"," (n=", publisher_nature_n,')'))
publisher_cell <- d_all %>% filter(journal == "CELL") %>% mutate(journal = paste0("Cell journals"," (n=", publisher_cell_n,')'))
publisher_frontiers <- d_all %>% filter(journal == "Frontiers in Microbiology") %>% mutate(journal = paste0("Frontiers journals"," (n=", publisher_frontiers_n,')'))

# combine the journals with no publisher guidance with the publisher guidance rows
d_internal_guidance <- bind_rows(d_internal_guidance_noPublisher, publisher_nature, publisher_cell, publisher_frontiers)

# list of journals in order of most topics mentioned
journals_topics_mentioned_ordered <- d_internal_guidance %>%
  # Recode NAs to FALSE
  mutate(across(
    everything()
    , ~replace_na(., FALSE) )) %>% 
  select(journal, starts_with("has_"), -c(has_guidance, has_internal_guidance, has_internal_guidance_section, has_external_guidance, has_publisher_guidance)) %>%
  pivot_longer(cols = !journal, names_to = 'topic', values_to = 'value') %>%
  group_by(journal) %>%
  summarise(topics_mentioned = sum(value)) %>%
  arrange(topics_mentioned) %>%
  pull(journal)

plt <- d_internal_guidance %>%
  mutate(journal = factor(journal, levels = journals_topics_mentioned_ordered)) %>% # order journals by n topics mentioned
  select(journal, starts_with("has_") & (!contains("guidance"))) %>%
  mutate(journal = fct_recode(journal,"PNAS" = "PROCEEDINGS OF THE NATIONAL ACADEMY OF SCIENCES OF THE UNITED STATES OF AMERICA")) %>% # shorten a particularly long journal name
  pivot_longer(
    -journal,
    names_to = "topic",
    names_prefix = 'has_',
    values_to = "outcome",
    values_drop_na = FALSE
  ) %>%
  mutate(outcome = case_when(
    outcome ~ "Mentioned",
    !outcome ~ "Not mentioned",
    TRUE ~ "Not applicable (No internal guidance)"
  )) %>%
  mutate(topic_display = case_when( # create display versions of topic names
    topic == "guidance" ~ "Provides any statistical guidance",
    topic == "internal_guidance" ~ "Provides journal-specific statistical guidance",
    topic == "internal_guidance_section" ~ "Has a dedicated statistical guidance section",
    topic == "external_guidance" ~ "Refers to external statistical guidance",
    topic == "p_value" ~ "p values",
    topic == "significance" ~ "statistical significance",
    topic == "null_hypo" ~ "null hypotheses",
    topic == "sample_size" ~ "sample size justification",
    topic == "conf_int" ~ "confidence intervals",
    topic == "effect_size" ~ "effect sizes",
    topic == "multi_compare" ~ "multiple comparisons",
    topic == "subgroup" ~ "subgroup analyses",
    topic == "baseline_covar" ~ "baseline covariates",
    topic == "non_param" ~ "non-parametric tests",
    topic == "sensitivity" ~ "sensitivity analyses",
    topic == "model_assume" ~ "checking model assumptions",
    topic == "exclusion" ~ "data exclusions",
    topic == "outliers" ~ "handling outliers",
    topic == "missing" ~ "handling missing data",
    topic == "one_sided" ~ "one-sided tests",
    topic == "bayes" ~ "Bayesian statistics",
    topic == "secondary" ~ "secondary outcomes",
    topic == "prespecify" ~ "prespecification of analyses",
    topic == "cat_continuous" ~ "categorisation of continuous data",
    topic == "publisher_guidance" ~ "Shares publisher guidance"
  )) %>%
  ggplot(aes(x = topic_display, y = journal)) +
    geom_tile(aes(fill = outcome), colour = 'black', size = .25, alpha = .6) +
    scale_fill_manual(
      values = my_palette,
      # labels = c('Not mentioned', 'Unclear', 'Mentioned')
    ) +
    scale_x_discrete(position = 'top') +
    scale_y_discrete(labels = wrap_format(25)) + # wrap text on y axis
    xlab("Statistical topics") +
    theme(plot.margin = margin(0, 50, 0, 0),
          axis.ticks = element_blank(),
          axis.title.y =element_blank(),
          axis.line = element_blank(),
          panel.grid.major=element_line(colour=NA),
          panel.grid.minor=element_line(colour=NA),
          legend.position = 'top',
          axis.text.x  = element_text(angle = 45, hjust = 0),
          strip.background = element_rect(
            color="black", fill="white", size=0, linetype="solid"
          ),
          strip.text.y = element_text(
            size = 8, color = "black", face = 'bold'
          ))

# ggsave('internal-guidance.png', width = 11, height = 10)
```

```{r guidancemosaic, fig.cap = "Grid diagram showing whether each journal provdied guidance on each of twenty prespecified statistical topics", fig.height = 35, fig.width = 10}
plt
```

```{r guidance_examples}
# get the names of the twenty statistical topics
topic_names <- d_all %>% 
  select(starts_with("has_"), -c(has_guidance, has_external_guidance, has_internal_guidance, has_internal_guidance_section, has_publisher_guidance)) %>% 
  rename_all(~str_replace(.,"^has_","")) %>% # remove has_ prefix
  verify(ncol(.) == 20) %>% # check there are twenty columns (topics) as expected
  colnames()

set.seed(42)
guidance_examples_tbl <- d_all %>%
  select(journal, topic_names) %>% 
  verify(ncol(.) == 21) %>% # check there are 21 columns as expected (i.e., journal and twenty topics)
  pivot_longer(cols = !journal, names_to = 'topic', values_to = 'verbatim') %>%
  distinct(verbatim, .keep_all = T) %>%
  drop_na(verbatim) %>%
  filter(nchar(verbatim) < 800) %>% # select shorter guidance only
  group_by(topic) %>%
  sample_n(2) %>%
  ungroup() %>%
  mutate(verbatim = paste0(verbatim,' (',journal,')')) %>% # add journal name to verbatim column
  select(-journal) %>% # remove journal column
  mutate(topic_display = case_when( # create display versions of topic names
    topic == "p_value" ~ "p values",
    topic == "significance" ~ "statistical significance",
    topic == "null_hypo" ~ "null hypotheses",
    topic == "sample_size" ~ "sample size justification",
    topic == "conf_int" ~ "confidence intervals",
    topic == "effect_size" ~ "effect sizes",
    topic == "multi_compare" ~ "multiple comparisons",
    topic == "subgroup" ~ "subgroup analyses",
    topic == "baseline_covar" ~ "baseline covariates",
    topic == "non_param" ~ "non-parametric tests",
    topic == "sensitivity" ~ "sensitivity analyses",
    topic == "model_assume" ~ "checking model assumptions",
    topic == "exclusion" ~ "data exclusions",
    topic == "outliers" ~ "handling outliers",
    topic == "missing" ~ "handling missing data",
    topic == "one_sided" ~ "one-sided tests",
    topic == "bayes" ~ "Bayesian statistics",
    topic == "secondary" ~ "secondary outcomes",
    topic == "prespecify" ~ "prespecification of analyses",
    topic == "cat_continuous" ~ "categorisation of continuous data"
  )) %>%
  select(topic = topic_display,"example guidance" =verbatim)
```

To give you a flavour of the kind of guidance provided, I have randomly selected two examples (excluding a few very long examples), for each of the twenty statistical topics, and displayed them in Table \@ref(fig:guidanceexamples) below.

```{r guidanceexamples}
guidance_examples_tbl %>% kable()
```


Look at external guidance

```{r tbl_external_guidance}
lookup_external_guidance %>% 
  knitr::kable()
```

External guidance types

```{r tbl_external_guidance_types}
lookup_external_guidance %>% 
  count(guidance_type) %>% 
  kable()
```

# Issues to address {#issues}

* Our coding for the topic "prespecification of analyses" was not consistent across coders. Specifically, some coders considered guidance/instructions related to registration of clinical trials to be covered by this topic, whilst others did not. I believe the justification of those who did not was that clinical trials registration does not necessarily involve prespecification of a statistical analysis plan. That seems a reasonable justification to me, but I'd be interested to hear thoughts from the team. If we decide that advice about clinical trials registration alone does not fall into the remit of this topic, then it is relatively straightforward to examine the verbatim text we extracted and re-code the relevant cases. However, if we decide that advice about clinical trials registration *does* fall under the remit of this topic, then we will need to re-visit the journal instructions to authors and search for such guidance (as this was not done consistently previously).

* We have recorded whether journals refer to statistical guidance from external sources, such as reporting guidelines or academic papers. However, we have not examined those external sources, and we need to decide whether to do so. If we perform extraction and coding for all `r lookup_external_guidance %>% nrow()` external sources we have identified, this is clearly a lot of extra work. We also perhaps only really interested in the most salient statistical guidance offered by journals. On the other hand, if we do not extract information from external sources, then perhaps we are missing an important aspect of statistical guidance i.e., that journals may not provide their own guidance on certain topics because they are aptly covered by external sources. An additional complication is that in some cases, the boundary of internal vs external guidance is blurred when the 'external' source is an academic article that appears to have been written by members of the journal's editorial team. 

# Appendix {#app}

Tabular data (represented in Figures 1 and 2). There is a scroll bar at the bottom of the table to see all of the scientific fields.

```{r tbl_counts_props}
tbl_counts_props <-
d_all %>%
  
  # Recode NAs to FALSE
  mutate(across(
    everything()
    # starts_with("has_") & (!contains("guidance")) # for internal guidance elements
    , ~replace_na(., FALSE) )) %>% 
  
  select(esi_field, starts_with("has_")) %>% 
  gtsummary::tbl_summary(
    by = esi_field,
      # statistic = list(everything() ~ "{p}% ({n} / {N})")
  ) %>%
  add_overall %>% 
  modify_footnote(everything() ~ NA) %>% 
  modify_caption("**Number and percentage of journals overall and by scientific discipline providing internal statistical guidance by topic.** Denominator for all proportions is the number of journals in the field, regardless of whether the journal has internal guidance.")

tbl_counts_props
```

## {gtsummary} in-text demo

> Overall stats are in the `stat_0` column, which is not accessible in the current release of {gtsummary}, so hence use the dev version: `remotes::install_github("ddsjoberg/gtsummary")`.

You can see that around half (`r inline_text(tbl_counts_props, variable = has_guidance, column = stat_0, pattern = "{p}")`%) of journals offered any statistical guidance. Note that this includes `r only_ext` journals which only referred to statistical guidance in external sources (reporting guidelines or academic papers). Just over quarter of journals had a dedicated statistical guidance section of their author instructions (`r inline_text(tbl_counts_props, variable = has_internal_guidance_section, column = stat_0, pattern = "{p}")`%). In two fields (Computer Science and Maths), no journals offered any statistical guidance. Journals in health-related fields were more likely to offer statistical guidance and have dedicated statistical guidance sections. Notably, 100% of the journals in clinical medicine offered some statistical guidance. 

```{r}
#### CODE GRAVEYARD - BEWARE ####

# try binning method
# forPlot %>%
#   #mutate(bin = cut_width(prop, width = 0.2, center = 0.1)) %>%
#   mutate(bin = cut_width(percent, width = 20, center = 10)) %>%
#   group_by(esi_field,bin) %>%
#   summarise(n = n()) %>%
#   group_by(bin) %>%
#   summarise(esi_field = esi_field, pos = cumsum(n)) %>%
#   merge(forPlot, by = "esi_field") %>% # rejoin columns from original dataframe
#   ggplot(aes(x=percent, y = pos, colour = esi_field)) +
#   geom_vline(xintercept = sum_tab %>% filter(variable == "guidance", esi_field == "OVERALL") %>% pull(percent)) +
#   geom_point(size = 5) +
#   geom_label_repel(aes(label = esi_abbr)) +
#   theme_minimal() +
#   theme(axis.title.y = element_blank(),
#         axis.text.y = element_blank(),
#         axis.ticks.y = element_blank()) +
#   scale_colour_discrete()



# # trying out a dot histogram
# d <- sum_tab %>%
#   #filter(variable %in% c('guidance', 'internal_guidance', 'internal_guidance_section', 'external_guidance')) %>%
#   filter(variable %in% c('guidance'))
# 
# sum_tab %>%
#   filter(variable %in% c('guidance', 'internal_guidance', 'internal_guidance_section', 'external_guidance')) %>%
#   ggplot(aes(x = prop, fill=esi_field, label = esi_abbr, group = esi_field)) + 
#     #geom_histogram(aes(fill=esi_field), binwidth=0.1, colour="grey20", lwd=0.2) +
#     geom_dotplot(binwidth=0.1, colour="grey20", lwd=0.2, stackgroups = T, binpositions = 'all', method = 'histodot', dotsize = 0.25, stackdir = 'center') +
#     facet_grid(rows = vars(variable)) +
#     theme(axis.title.y = element_blank(), # y axis labels are meaningless on this plot, remove them
#       axis.text.y = element_blank(),
#       legend.position = 'bottom')
# 
#   # looks ok... but difficult to tell which field is which (too many similar colours, and have to keep looking at legend)
#   # could we put the field abbreviation text inside the dots? (maybe shorten to two letters)
#   # also for OVERALL we need something different, e.g., a black vertical line
```

```{r phase_two}
# export data for phase two
d_all %>% filter(has_p_value == T | has_significance == T) %>% 
  mutate(coder = "TEH") %>% 
  select(journal, esi_field, p_value, significance) %>%
  mutate(recommended_required = NA,
         p_how = NA,
         p_threshold = NA,
         stat_sig_ok = NA,
         stat_sig_alpha = NA) %>%
  write_csv(here('data','raw','templates','phase_two_pval.csv'))


```

